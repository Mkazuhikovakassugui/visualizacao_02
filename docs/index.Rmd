---
title: "Relatório de desempenho dos alunos no Exame Nacional de Ensino Médio (ENEM)"
output: 
  html_document:
    highlight: breezedark
    code_folding: hide
    self_contained: true
    theme: cosmo
    toc: yes
    toc_float: yes
    smooth_scroll: no
    collapsed: yes
params:
    cidade: "Santa Helena"
    estado: "PR"
css: custom.css
---

```{r setup geral}
#| include = FALSE

knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 14,
  fig.height = 7
)
```

```{r Leitura da base de dados}
#| echo = FALSE
enem <- readr:: read_csv("../data/enem_analise_final.csv")

```
```{r base de dados para cidade e ano escolhidos}
#| echo = FALSE

enem_cidade <- enem |> 
  dplyr::filter(no_municipio_prova == params$cidade & nu_ano == 2020)

```



```{r total de alunos}
#| echo = FALSE
total_alunos_municipio <- enem_cidade |> 
    dplyr::summarise(total_alunos = dplyr::n())

```

<br>

# Informações Gerais

| Município: `r params$cidade` |                                  Estado: `r params$estado` |
|:-----------------------------|-----------------------------------------------------------:|
| Autor: Marcio Vakassugui     |                                       Data: `r Sys.Date()` |
|                              | Total de alunos: `r total_alunos_municipio`                |

<br>

```{os estados da federacao}
#| echo = FALSE

estado_federacao <- dplyr::case_when(
    params$estado == "AC" ~ "Acre",
    params$estado == "AL" ~ "Alagoas",
    params$estado == "AP" ~ "Amapá",
    params$estado == "AM" ~ "Amazonas", 
    params$estado == "BA" ~ "Bahia", 
    params$estado == "CE" ~ "Ceará", 
    params$estado == "DF" ~ "Distrito Federal", 
    params$estado == "ES" ~ "Espírito Santo", 
    params$estado == "GO" ~ "Goiás",
    params$estado == "MA" ~ "Maranhão", 
    params$estado == "MT" ~ "Mato Grosso",
    params$estado == "MS" ~ "Mato Grosso do Sul",
    params$estado == "MG" ~ "Minas Gerais", 
    params$estado == "PA" ~ "Pará", 
    params$estado == "PB" ~ "Paraíba", 
    params$estado == "PR" ~ "Paraná",
    params$estado == "PE" ~ "Pernambuco", 
    params$estado == "PI" ~ "Piauí", 
    params$estado == "RJ" ~ "Rio de Janeiro", 
    params$estado == "RN" ~ "Rio Grande do Norte",
    params$estado == "RS" ~ "Rio Grande do Sul", 
    params$estado == "RO" ~ "Rondônia", 
    params$estado == "RR" ~ "Roraima", 
    params$estado == "SC" ~ "Santa Catarina",
    params$estado == "SP" ~ "São Paulo",
    params$estado == "SE" ~ "Sergipe",
    params$estado == "TO" ~ "Tocantins"
)
```

# Informações sobre a prova de redação

<br>

A nota da redação é composta por cinco competências com notas que variam de 0 a 200 pontos. A soma das seguintes competências resulta na nota final da redação do aluno.

1.  Demonstrar domínio da modalidade escrita formal da Língua Portuguesa;

2.  Compreender a proposta de redação e aplicar conceitos das várias áreas de conhecimento para desenvolver o tema, dentro dos limites estruturais do texto dissertativo-argumentativo em prosa;

3.  Selecionar, relacionar, organizar e interpretar informações, fatos, opiniões e argumentos em defesa de um ponto de vista;

4.  Demonstrar conhecimento dos mecanismos linguísticos necessários para a construção da argumentação;

5.  Elaborar proposta de intervenção para o problema abordado, respeitando os direitos humanos.

<br>

### Notas médias das competências

```{r preparacao dos dados para o plot1}
#| echo = FALSE

# ANÁLISES DAS MÉDIAS DAS NOTAS QUE COMPÕEM AS NOTAS DA REDAÇÃO

# Cálculo das médias dos componentes da redação
medias_comp_redacao <- enem_cidade |>
  dplyr::summarise(dplyr::across(
    .cols = dplyr::starts_with("nu_nota_comp"),
    .fns = mean, na.rm = TRUE
  ))

medias_comp_redacao <- medias_comp_redacao |>                           # renomear as variáveis
  dplyr::rename(
    "comp1" = "nu_nota_comp1",
    "comp2" = "nu_nota_comp2",
    "comp3" = "nu_nota_comp3",
    "comp4" = "nu_nota_comp4",
    "comp5" = "nu_nota_comp5"
  )

# VISUALIZAÇÃO DO RESULTADO

# Pivotar a base para long
medias_comp_redacao <- medias_comp_redacao |>
    tidyr::pivot_longer(
        cols = c(
            "comp1",
            "comp2",
            "comp3",
            "comp4",
            "comp5"),
        names_to = "notas_comp_redacao",
        values_to = "medias") |>
    dplyr::mutate(notas_comp_redacao = as.factor(notas_comp_redacao))

```


```{r plot1 - Media dos componentes da redacao}

source("../R/funcao_tema_graficos.R")

# Cosntruir o gráfico de barras das médias dos componentes que compõem a nota da redação
p1 <- medias_comp_redacao |>                                                             # base
  dplyr::mutate(
    notas_comp_redacao = forcats::fct_reorder(
      notas_comp_redacao,
      medias,
      .desc = TRUE
    )
  ) |>
  ggplot2::ggplot() +                                                                 # gráfico
  ggplot2::aes(
    x = notas_comp_redacao,
    y = medias,
    label = round(medias, 2)
  ) +
  ggplot2::geom_col(
    fill = "#576BC7"
  ) +
  ggplot2::geom_label(                                                                 # labels
    size = 5,
    color = "#D6F3FF",
    alpha = 0,
    nudge_y = -10
  ) +
  ggplot2::labs(                                                            # títulos dos eixos
    title = "Médias dos componentes da redação",
    subtitle = "A nota da redação é definida pela soma dos componentes",
    x = "notas dos componentes",
    y = "média das notas"
  ) +
  ggplot2::theme_classic() +                                                             # tema
  ggplot2::theme(
    legend.position = "none"
  ) +
  theme_enem()
 
p1

```

```{r competencias da redacao com maior e menor média}
#| echo = FALSE

comp_max <- medias_comp_redacao |> 
    dplyr::slice_max(order_by = medias)

comp_min <- medias_comp_redacao |> 
    dplyr::slice_min(order_by = medias)

melhor_componente_redacao <- dplyr::case_when(
    medias_comp_redacao[["medias"]][1] == comp_max ~ "competência um",
    medias_comp_redacao[["medias"]][2] == comp_max ~ "competência dois",
    medias_comp_redacao[["medias"]][3] == comp_max ~ "competência três",
    medias_comp_redacao[["medias"]][4] == comp_max ~ "competência quatro",
    medias_comp_redacao[["medias"]][5] == comp_max ~ "competência cinco"
)


pior_componente_redacao <- dplyr::case_when(
    medias_comp_redacao[["medias"]][1] == comp_min ~ "competência um",
    medias_comp_redacao[["medias"]][2] == comp_min ~ "competência dois",
    medias_comp_redacao[["medias"]][3] == comp_min ~ "competência três",
    medias_comp_redacao[["medias"]][4] == comp_min ~ "competência quatro",
    medias_comp_redacao[["medias"]][5] == comp_min ~ "competência cinco"
    )

melhor_competencia <- dplyr::case_when(
    comp_max[1] == "comp1" ~ "demonstrar domínio da modalidade escrita formal da Língua Portuguesa",
    comp_max[1] == "comp2" ~ "compreender a proposta de redação e aplicar conceitos das várias áreas de conhecimento para desenvolver o tema, dentro dos limites estruturais do texto dissertativo-argumentativo em prosa",
    comp_max[1] == "comp3" ~ "selecionar, relacionar, organizar e interpretar informações, fatos, opiniões e argumentos em defesa de um ponto de vista",
    comp_max[1] == "comp4" ~ "demonstrar conhecimento dos mecanismos linguísticos necessários para a construção da argumentação",
    comp_max[1] == "comp5" ~ "elaborar proposta de intervenção para o problema abordado, respeitando os direitos humanos"
)

pior_competencia <- dplyr::case_when(
    comp_min[1] == "comp1" ~ "demonstrar domínio da modalidade escrita formal da Língua Portuguesa",
    comp_min[1] == "comp2" ~ "compreender a proposta de redação e aplicar conceitos das várias áreas de conhecimento para desenvolver o tema, dentro dos limites estruturais do texto dissertativo-argumentativo em prosa",
    comp_min[1] == "comp3" ~ "selecionar, relacionar, organizar e interpretar informações, fatos, opiniões e argumentos em defesa de um ponto de vista",
    comp_min[1] == "comp4" ~ "demonstrar conhecimento dos mecanismos linguísticos necessários para a construção da argumentação",
    comp_min[1] == "comp5" ~ "elaborar proposta de intervenção para o problema abordado, respeitando os direitos humanos"
)

```

Os alunos que realizaram o exame na cidade de **`r params$cidade`** obtiveram o melhor desempenho na `r melhor_componente_redacao[2]` da redação, `r melhor_competencia`, com a média de **`r round(medias_comp_redacao[["medias"]][1],2)`** e o pior desempenho na `r pior_componente_redacao[2]`, `r pior_competencia`, com a média de **`r round(medias_comp_redacao[["medias"]][5],2)`**.

```{r notas máximas, quantidade de zeros, média e percentual de zeros no município}
#| echo = FALSE

nota_max <- enem_cidade |>
    dplyr::summarize(nota_max = max(nu_nota_redacao))

nota_min <- enem_cidade |>
    dplyr::summarise(nota_min = min(nu_nota_redacao))

nota_media <- enem_cidade |>
    dplyr::summarise(nota_media = mean(nu_nota_redacao, na.rm = TRUE))

zeros_redacao <- enem |>
    dplyr::filter(no_municipio_prova == params$cidade & nu_nota_redacao == 0 & nu_ano == 2020) |>
    dplyr:: summarise(qtde_zeros = dplyr::n())

perc_zeros_redacao <- enem_cidade |>
    dplyr::summarise(perc_zeros_redacao = round((zeros_redacao / total_alunos_municipio)*100,3))

```

```{r base para grafico freq_relativa notas por intervalo de classes}
#| echo = FALSE

fabs_notas_redacao <- enem_cidade |>
  dplyr::select(nu_nota_redacao) |>
  table()

# total de alunos com nota máxima

qtd_nota_max <- fabs_notas_redacao |>
  tail(n=1) 

# criar as classes de frequências das notas

intervalo_classes_notas <- seq(0, 1000, 100)
tab_classes_notas <- table(cut(enem_cidade$nu_nota_redacao,
                               breaks = intervalo_classes_notas,
                               right = FALSE)) |>
  prop.table() |>
  data.frame() |>
  dplyr::mutate(Freq = Freq*100)

```


A nota máxima **`r nota_max`** foi obtida por `r qtd_nota_max` aluno(s) e a nota média foi de **`r round(nota_media,3)`**. Um total de **`r zeros_redacao`** participante(s) entre os **`r total_alunos_municipio`** alunos obtiveram nota zero , o que representa um percentual de **`r perc_zeros_redacao`%**.

<br>

### Distribuição das notas por competências

```{r gráfico de densidade de distribuição das notas por competências}

# pivotar a base
comp_redacao <- enem_cidade |>
  dplyr::select(nu_nota_comp1,
                nu_nota_comp2,
                nu_nota_comp3,
                nu_nota_comp4,
                nu_nota_comp5) |>
  dplyr::rename("comp1" = "nu_nota_comp1",
                "comp2" = "nu_nota_comp2",
                "comp3" = "nu_nota_comp3",
                "comp4" = "nu_nota_comp4",
                "comp5" = "nu_nota_comp5",)

comp_redacao_long <- comp_redacao |>
  tidyr::pivot_longer(
    cols = c(
      "comp1",
      "comp2",
      "comp3",
      "comp4",
      "comp5"
    ),
    names_to = "competencias",
    values_to = "notas_comp"
  ) |>
  dplyr::mutate(competencias = as.factor(competencias))

p2 <- comp_redacao_long |>
  ggplot2::ggplot(ggplot2::aes(competencias, notas_comp, fill = competencias))+
  ggplot2::geom_violin(width = 0.6)+
  ggplot2::geom_boxplot(width = 0.1, color = "black", alpha = 0.2)+
  #ggplot2::geom_jitter(color="black", size=0.4, alpha=0.02) +  
  ggplot2::labs(
    title = "Violinplot e boxplot das competências",
    x = "Competências",
    y = "notas"
  )+
  theme_enem()+
  ggplot2::theme(
    legend.position = "none"
  )

p2
```

No gráfico acima, pode-se observar a densidade de distribuição das notas por competências exigidas na redação e as médias já apresentadas no gráfico 01. Os locais de maior área em torno dos boxplots representam maiores concentrações de dados, enquanto que locais de menor área indicam baixa concentração de dados.

```{r gráfico freq_relativa notas por intervalo de classes}

p3 <- tab_classes_notas |>
  ggplot2::ggplot()+
  ggplot2::aes(x= Var1,
               y = Freq,
               label = round(Freq, 3))+
  ggplot2::geom_col(fill = "#576BC7") +
  ggplot2::geom_label(                                                                 # labels
    size = 5,
    color = "#576BC7",
    alpha = 0,
    nudge_y = 1.5
  ) +
  ggplot2::labs(                                                            # títulos dos eixos
    title = "Frequências relativas de notas por intervalos de classe",
    x = "Intervalo de notas",
    y = "Frequência (%)"
  )+
  ggplot2::theme_classic()+
  theme_enem()

p3



```

