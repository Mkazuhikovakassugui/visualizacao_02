---
title: "Relatório de desempenho dos alunos no Exame Nacional de Ensino Médio (ENEM) por município"
author: "Marcio Vakassugui"
output: 
  html_document:
    highlight: breezedark
    code_folding: hide
    self_contained: true
    theme: cosmo
    toc: yes
    toc_float: yes
    smooth_scroll: no
    collapsed: yes
params:
    cidade: "Londrina"
    estado: "PR"
css: custom.css
---

```{r label= 'setup_geral'}
#| include = FALSE

knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 14,
  fig.height = 7
)
```

```{r label = 'leitura_base_de_dados'}
#| echo = FALSE

enem <- readr:: read_csv("../data/enem_analise_final.csv")

```

```{r label =  'base_para_cidade_e_ano'}
#| echo = FALSE

enem_cidade <- enem |> 
  dplyr::filter(no_municipio_prova == params$cidade & nu_ano == 2020)

```

<br>

# Objetivo

Elaborar um modelo de relatório em HTML, produzido em RMarkdown, que apresente o desempenho dos alunos na prova do Exame Nacional do Ensino Médio (ENEM) por município.

O modelo deve ter a característica de reprodutibilidade, de modo que relatórios (formato, textos e visualizações) sejam produzidos por meio de uma rotina de procedimentos (script com o uso do recurso *params* do Rmarkdown) de forma automatizada para todos os 88 municípios do estado do Paraná, nos quais as provas foram realizadas.

```{r label = 'total_de_alunos'}
#| echo = FALSE
total_alunos_municipio <- enem_cidade |> 
    dplyr::summarise(total_alunos = dplyr::n())

```

<br>

# Informações Gerais

| Município: `r params$cidade`                | Estado: `r params$estado` |
|:--------------------------------------------|--------------------------:|

```{r label = 'base_mapa_cidade'}
#| echo = FALSE,
#| include = FALSE

library(geobr)
library(sf)
source("../R/funcao_tema_graficos.R")

dados_geobr <- geobr::read_municipality("PR")

```


```{r label = 'mapa_municipio'}

dados_geobr |>
  dplyr::filter(name_muni == params$cidade) |>
  ggplot2::ggplot()+
  ggplot2::geom_sf(data = dados_geobr,
                   fill = "#70A288",
                   color = "#000000",
                   size = .1)+
  ggplot2::geom_sf(fill = "red")+
  ggspatial::annotation_north_arrow(location = "br")+
  ggplot2::theme_classic()+
  theme_enem()

```

<br>

|                |  |
|:--------------------------------------------|--------------------------:|
| Alunos classificados: `r total_alunos_municipio` |      Data: `r Sys.Date()` |

<br>

```{r label = 'lista_estados_da_federacao'}
#| echo = FALSE

estado_federacao <- dplyr::case_when(
    params$estado == "AC" ~ "Acre",
    params$estado == "AL" ~ "Alagoas",
    params$estado == "AP" ~ "Amapá",
    params$estado == "AM" ~ "Amazonas", 
    params$estado == "BA" ~ "Bahia", 
    params$estado == "CE" ~ "Ceará", 
    params$estado == "DF" ~ "Distrito Federal", 
    params$estado == "ES" ~ "Espírito Santo", 
    params$estado == "GO" ~ "Goiás",
    params$estado == "MA" ~ "Maranhão", 
    params$estado == "MT" ~ "Mato Grosso",
    params$estado == "MS" ~ "Mato Grosso do Sul",
    params$estado == "MG" ~ "Minas Gerais", 
    params$estado == "PA" ~ "Pará", 
    params$estado == "PB" ~ "Paraíba", 
    params$estado == "PR" ~ "Paraná",
    params$estado == "PE" ~ "Pernambuco", 
    params$estado == "PI" ~ "Piauí", 
    params$estado == "RJ" ~ "Rio de Janeiro", 
    params$estado == "RN" ~ "Rio Grande do Norte",
    params$estado == "RS" ~ "Rio Grande do Sul", 
    params$estado == "RO" ~ "Rondônia", 
    params$estado == "RR" ~ "Roraima", 
    params$estado == "SC" ~ "Santa Catarina",
    params$estado == "SP" ~ "São Paulo",
    params$estado == "SE" ~ "Sergipe",
    params$estado == "TO" ~ "Tocantins"
)
```

# Informações sobre a prova de redação

```{r label = 'notas_máximas_quantidade_de_zeros_média_município'}
#| echo = FALSE

nota_max <- enem_cidade |>
    dplyr::summarize(nota_max = max(nu_nota_redacao))

nota_min <- enem_cidade |>
    dplyr::summarise(nota_min = min(nu_nota_redacao))

nota_media <- enem_cidade |>
    dplyr::summarise(nota_media = mean(nu_nota_redacao, na.rm = TRUE))

zeros_redacao <- enem |>
    dplyr::filter(no_municipio_prova == params$cidade & nu_nota_redacao == 0 & nu_ano == 2020) |>
    dplyr:: summarise(qtde_zeros = dplyr::n())

perc_zeros_redacao <- enem_cidade |>
    dplyr::summarise(perc_zeros_redacao = round((zeros_redacao / total_alunos_municipio)*100,3))

```

```{r label = 'base_grafico_freq_relativa_intervalo_de_classes'}
#| echo = FALSE

fabs_notas_redacao <- enem_cidade |>
  dplyr::select(nu_nota_redacao) |>
  table()

# total de alunos com nota máxima

qtd_nota_max <- fabs_notas_redacao |>
  tail(n=1) 

# criar as classes de frequências das notas

intervalo_classes_notas <- seq(0, 1000, 100)
tab_classes_notas <- table(cut(enem_cidade$nu_nota_redacao,
                               breaks = intervalo_classes_notas,
                               right = FALSE)) |>
  prop.table() |>
  data.frame() |>
  dplyr::mutate(Freq = Freq*100)

```

<br>

### Distribuição das notas de redação

<br> As notas das redações variam de 0 a 1000 pontos. No gráfico 01, pode-se visualizar por meio do boxPlot e do histograma a média e a distribuição das notas. <br>

```{r label = 'grafico_01'}
#| fig.cap = "Gráfico 01 - BoxPlot e histograma da distribuição de notas de redação"

# gráfico do boxplot das notas das redações (parte superior da visualização)
p1_1 <- enem_cidade |> 
  dplyr::select(nu_nota_redacao) |> 
  ggplot2::ggplot(ggplot2::aes(x = nu_nota_redacao))+
  ggplot2::geom_boxplot(fill = "#70A288")+
  ggplot2::labs(
    title = "Distribuição das notas de redação ",
    x = "",
    y = ""
  )+
  ggplot2::theme_bw()+
  theme_enem()


# gráfico do histograma das notas das redações (parte inferior da visualização)
p1_2 <- enem_cidade |> 
  dplyr::select(nu_nota_redacao) |> 
  ggplot2::ggplot(ggplot2::aes(x = nu_nota_redacao))+
  ggplot2::geom_histogram(fill = "#70A288",
                          color = "#000000")+
  ggplot2::labs(
    x = "notas",
    y = ""
  )+
  ggthemes::theme_map()+
  theme_enem()

library(patchwork)                            # uso do pacote patchwork para união dos gráficos

# disposição dos gráficos
p1 <- p1_1/p1_2
p1

```

<br>

Entre os alunos que realizaram o exame na cidade de **`r params$cidade`**, a maior nota **`r nota_max`** foi conquistada por `r qtd_nota_max` aluno(s). Entretanto, **`r zeros_redacao`** participante(s), entre os **`r total_alunos_municipio`** aluno(s), obtiveram nota zero , o que representa um percentual de **`r perc_zeros_redacao`%**. A nota média foi de **`r round(nota_media,3)`**.

<br>

### Distribuição das notas das redações por intervalo de classes.

```{r label = 'grafico_02'}
#| fig.cap = "Gráfico 02 - Diagrama de colunas da distribuição de notas por intervalos"


p2 <- tab_classes_notas |>
  ggplot2::ggplot()+
  ggplot2::aes(x= Var1,
               y = Freq,
               label = round(Freq, 3))+
  ggplot2::geom_col(fill = "#70A288",
                    color = "#000000") +
  ggplot2::geom_label(                                                                 # labels
    size = 5,
    color = "#000000",
    alpha = 0,
    nudge_y = 1.5
  ) +
  ggplot2::labs(                                                            # títulos dos eixos
    title = "Frequência relativa por intervalo de classes",
    x = "Intervalo de notas",
    y = "Frequência (%)"
  )+
  ggplot2::theme_classic()+
  theme_enem()

p2

```

<br> No gráfico 02, pode-se observar melhor como as notas de redação se distribuíram entre os valores de 0 a 1000. Os valores mostram o percentual de notas de cada intervalo. Valores maiores indicam a proporção de notas mais comuns.

<br>

### Principais problemas que resultam em anulação das redações

<br>

A banca avaliadora atribui nota 0 (zero) de acordo com as seguintes causas:<br>

1.  Não atendimento ao tipo: a redação que possua outra estrutura textual que não seja a estrutura dissertativo-argumentativo;

2.  Fuga ao tema: a que não atende à proposta solicitada;

3.  Em branco: a que não apresente texto escrito na folha de redação;

4.  Texto insuficiente: a que apresente até 7 linhas, qualquer que seja o conteúdo;

5.  Parte desconectada: a que apresenta parte do texto deliberadamente desconectada com o tema proposto;

6.  Anulada: a que apresenta impropérios, desenhos ou outras formas propositais de anulação;

7.  Cópia Texto Motivador: a cópia de textos motivadores enseja a desconsideração das linhas para efeito de correção e de contagem do número mínimos de linhas, podendo levar à nota 0 no caso de incidência em algum dos motivos citados acima.

<br>

```{r label = 'grafico_03'}
#| fig.cap = "Gráfico 03 - Diagrama de barras razões para notas zero"

redacoes_com_problemas <- enem_cidade |>
  dplyr::filter(nu_nota_redacao == 0) |>
  dplyr::group_by(tp_status_redacao) |>
  dplyr::summarise(qte = dplyr::n()) |>
  dplyr::mutate(tp_status_redacao = as.factor(tp_status_redacao))


p3 <- redacoes_com_problemas |>
  ggplot2::ggplot(ggplot2::aes(x = qte,
                               y = tp_status_redacao,
                               label = qte))+
  ggplot2::geom_col(fill = "#70A288")+
  ggplot2::geom_label(                                                                 # labels
    size = 5,
    color = "#000000",
    alpha = 0,
    nudge_x = 3.5
    ) +
  ggplot2::labs(                                                            # títulos dos eixos
    title = "Principais razões para eliminação das redações",
    x = "quantidades",
    y = "razões"
  ) +
  ggplot2::theme_classic()+
  theme_enem()

p3


```

```{r label = "maior_motivo_anulacao_redacao"}
#| echo = FALSE

motivo_maior_redacoes_com_problemas <- redacoes_com_problemas |> 
  dplyr::arrange(desc(qte)) |> 
  dplyr::slice_head()

```

<br> **`r motivo_maior_redacoes_com_problemas[1]`** foi a principal causa de notas zero nas redações dos alunos de `r params$cidade` , com `r motivo_maior_redacoes_com_problemas[2]` casos.

<br>

### Notas médias das competências

<br>

A nota da redação é composta por cinco competências com notas que variam de 0 a 200 pontos. A soma das seguintes competências resulta na nota final da redação do aluno.

1.  Demonstrar domínio da modalidade escrita formal da Língua Portuguesa;

2.  Compreender a proposta de redação e aplicar conceitos das várias áreas de conhecimento para desenvolver o tema, dentro dos limites estruturais do texto dissertativo-argumentativo em prosa;

3.  Selecionar, relacionar, organizar e interpretar informações, fatos, opiniões e argumentos em defesa de um ponto de vista;

4.  Demonstrar conhecimento dos mecanismos linguísticos necessários para a construção da argumentação;

5.  Elaborar proposta de intervenção para o problema abordado, respeitando os direitos humanos.

<br>

```{r label = 'preparacao_dados_media_componentes'}
#| echo = FALSE

# ANÁLISES DAS MÉDIAS DAS NOTAS QUE COMPÕEM AS NOTAS DA REDAÇÃO

# Cálculo das médias dos componentes da redação
medias_comp_redacao <- enem_cidade |>
  dplyr::summarise(dplyr::across(
    .cols = dplyr::starts_with("nu_nota_comp"),
    .fns = mean, na.rm = TRUE
  ))

medias_comp_redacao <- medias_comp_redacao |>                           # renomear as variáveis
  dplyr::rename(
    "comp1" = "nu_nota_comp1",
    "comp2" = "nu_nota_comp2",
    "comp3" = "nu_nota_comp3",
    "comp4" = "nu_nota_comp4",
    "comp5" = "nu_nota_comp5"
  )

# VISUALIZAÇÃO DO RESULTADO

# Pivotar a base para long
medias_comp_redacao <- medias_comp_redacao |>
    tidyr::pivot_longer(
        cols = c(
            "comp1",
            "comp2",
            "comp3",
            "comp4",
            "comp5"),
        names_to = "notas_comp_redacao",
        values_to = "medias") |>
    dplyr::mutate(notas_comp_redacao = as.factor(notas_comp_redacao))

```

```{r label = 'grafico_04'}
#| fig.cap = "Gráfico 04 - Média das notas por competências das redações"


# Cosntruir o gráfico de barras das médias dos componentes que compõem a nota da redação
p4 <- medias_comp_redacao |>                                                             # base
  dplyr::mutate(
    notas_comp_redacao = forcats::fct_reorder(
      notas_comp_redacao,
      medias,
      .desc = TRUE
    )
  ) |>
  ggplot2::ggplot() +                                                                 # gráfico
  ggplot2::aes(
    x = notas_comp_redacao,
    y = medias,
    label = round(medias, 2)
  ) +
  ggplot2::geom_col(
    fill = "#70A288",
    color = "#000000"
  ) +
  ggplot2::geom_label(                                                                 # labels
    size = 5,
    color = "#000000",
    alpha = 0,
    nudge_y = 7
  ) +
  ggplot2::labs(                                                            # títulos dos eixos
    title = "Médias dos componentes da redação",
    subtitle = "A nota da redação é definida pela soma dos componentes",
    x = "notas dos componentes",
    y = "média das notas"
  ) +
  ggplot2::theme_classic() +                                                             # tema
  ggplot2::theme(
    legend.position = "none"
  ) +
  theme_enem()
 
p4

```

```{r label = 'competencias_redacao_maior_menor_media'}
#| echo = FALSE

comp_max <- medias_comp_redacao |> 
    dplyr::slice_max(order_by = medias)

comp_min <- medias_comp_redacao |> 
    dplyr::slice_min(order_by = medias)

melhor_componente_redacao <- dplyr::case_when(
    medias_comp_redacao[["medias"]][1] == comp_max ~ "competência um",
    medias_comp_redacao[["medias"]][2] == comp_max ~ "competência dois",
    medias_comp_redacao[["medias"]][3] == comp_max ~ "competência três",
    medias_comp_redacao[["medias"]][4] == comp_max ~ "competência quatro",
    medias_comp_redacao[["medias"]][5] == comp_max ~ "competência cinco"
)


pior_componente_redacao <- dplyr::case_when(
    medias_comp_redacao[["medias"]][1] == comp_min ~ "competência um",
    medias_comp_redacao[["medias"]][2] == comp_min ~ "competência dois",
    medias_comp_redacao[["medias"]][3] == comp_min ~ "competência três",
    medias_comp_redacao[["medias"]][4] == comp_min ~ "competência quatro",
    medias_comp_redacao[["medias"]][5] == comp_min ~ "competência cinco"
    )

melhor_competencia <- dplyr::case_when(
    comp_max[1] == "comp1" ~ "demonstrar domínio da modalidade escrita formal da Língua Portuguesa",
    comp_max[1] == "comp2" ~ "compreender a proposta de redação e aplicar conceitos das várias áreas de conhecimento para desenvolver o tema, dentro dos limites estruturais do texto dissertativo-argumentativo em prosa",
    comp_max[1] == "comp3" ~ "selecionar, relacionar, organizar e interpretar informações, fatos, opiniões e argumentos em defesa de um ponto de vista",
    comp_max[1] == "comp4" ~ "demonstrar conhecimento dos mecanismos linguísticos necessários para a construção da argumentação",
    comp_max[1] == "comp5" ~ "elaborar proposta de intervenção para o problema abordado, respeitando os direitos humanos"
)

pior_competencia <- dplyr::case_when(
    comp_min[1] == "comp1" ~ "demonstrar domínio da modalidade escrita formal da Língua Portuguesa",
    comp_min[1] == "comp2" ~ "compreender a proposta de redação e aplicar conceitos das várias áreas de conhecimento para desenvolver o tema, dentro dos limites estruturais do texto dissertativo-argumentativo em prosa",
    comp_min[1] == "comp3" ~ "selecionar, relacionar, organizar e interpretar informações, fatos, opiniões e argumentos em defesa de um ponto de vista",
    comp_min[1] == "comp4" ~ "demonstrar conhecimento dos mecanismos linguísticos necessários para a construção da argumentação",
    comp_min[1] == "comp5" ~ "elaborar proposta de intervenção para o problema abordado, respeitando os direitos humanos"
)

```

<br>

Os alunos obtiveram o melhor desempenho na `r melhor_componente_redacao[2]` da redação, `r melhor_competencia`, com a média de **`r round(comp_max[2],2)`** e o pior desempenho na `r pior_componente_redacao[2]`, `r pior_competencia`, com a média de **`r round(comp_min[2],2)`**.

<br>

### Distribuição das notas por competências

```{r label = 'base_do_grafico_05'}
#| echo = FALSE

# pivotar a base
comp_redacao <- enem_cidade |>
  dplyr::select(nu_nota_comp1,
                nu_nota_comp2,
                nu_nota_comp3,
                nu_nota_comp4,
                nu_nota_comp5) |>
  dplyr::rename("comp1" = "nu_nota_comp1",
                "comp2" = "nu_nota_comp2",
                "comp3" = "nu_nota_comp3",
                "comp4" = "nu_nota_comp4",
                "comp5" = "nu_nota_comp5",)

comp_redacao_long <- comp_redacao |>
  tidyr::pivot_longer(
    cols = c(
      "comp1",
      "comp2",
      "comp3",
      "comp4",
      "comp5"
    ),
    names_to = "competencias",
    values_to = "notas_comp"
  ) |>
  dplyr::mutate(competencias = as.factor(competencias))

```

```{r label = 'gráfico_05'}
#| fig.cap = "Gráfico 05 - ViolinPlot e BoxPlot das competências das notas de redação"


p5 <- comp_redacao_long |>
  ggplot2::ggplot(ggplot2::aes(competencias, notas_comp, fill = competencias))+
  ggplot2::geom_violin(width = 0.6)+
  ggplot2::geom_boxplot(width = 0.1, color = "black", alpha = 0.2)+
  #ggplot2::geom_jitter(color="black", size=0.4, alpha=0.02) +  
  ggplot2::labs(
    title = "Densidade de distribuição das notas das competências de redação",
    x = "Competências",
    y = "notas"
  )+
  theme_enem()+
  ggplot2::theme(
    legend.position = "none"
  )

p5
```

<br>

No gráfico acima, pode-se observar a densidade de distribuição das notas por competências exigidas na redação e as médias já apresentadas no gráfico 01. Os locais de maior área em torno dos boxplots representam maiores concentrações de dados, enquanto que locais de menor área indicam baixa concentração de dados.

<br>

### Evolução das notas das redações nos últimos anos

```{r label = 'base_grafico_06'}
#| echo = FALSE

## filtrar a base para a cidade
enem_redacao_historico <- enem |> 
  dplyr::filter(no_municipio_prova == params$cidade) |> 
  dplyr::select(nu_nota_redacao, nu_ano) |> 
  dplyr::group_by(nu_ano) |> 
  dplyr::summarise(media = mean(nu_nota_redacao, na.rm = TRUE))

## alterar tipo de ano para inteiro
enem_redacao_historico[["nu_ano"]] <- as.integer(enem_redacao_historico[["nu_ano"]])

enem_redacao_historico_notas900 <- enem |> 
  dplyr::filter(no_municipio_prova == params$cidade & nu_nota_redacao >=900) |> 
  dplyr::select(nu_nota_redacao, nu_ano) |> 
  dplyr::group_by(nu_ano) |> 
  dplyr::summarise(qtde = dplyr::n())


```


```{r label = 'gráfico_06'}
#| fig.cap = "Gráfico 06 - Gráfico de linhas das médias e notas acima de 900"
p6_1 <- enem_redacao_historico |> 
  ggplot2::ggplot()+
  ggplot2::aes(x = nu_ano,
               y = media)+
  ggplot2::geom_line(
    color = "grey"
    )+
  ggplot2::geom_point(
    shape = 21,
    color = "black",
    fill = "#70A288",
    size = 6
  )+
  ggplot2::theme_classic()+
  theme_enem()+
  ggplot2::labs(
    title = "Médias das notas"
  ) 
 
p6_2 <- enem_redacao_historico_notas900 |> 
  ggplot2::ggplot()+
  ggplot2::aes(x = nu_ano,
               y = qtde)+
  ggplot2::geom_line(
    color = "grey"
  )+
  ggplot2::geom_point(
    shape = 21,
    color = "black",
    fill = "#70A288",
    size = 6
  )+
  ggplot2::theme_classic()+
  theme_enem()+
  ggplot2::labs(
    title = "Notas acima de 900"
  ) 
library(patchwork)
p6 <-  p6_1 + p6_2

p6
```

